syms L_1xx L_1xy L_1xz L_1yy L_1yz L_1zz l_1x l_1y l_1z m_1 Ia_1 fv_1 fc_1 fo_1 real;
syms L_2xx L_2xy L_2xz L_2yy L_2yz L_2zz l_2x l_2y l_2z m_2 Ia_2 fv_2 fc_2 fo_2 real;
syms L_3xx L_3xy L_3xz L_3yy L_3yz L_3zz l_3x l_3y l_3z m_3 Ia_3 fv_3 fc_3 fo_3 real;

parms = [L_1xx, L_1yy, L_1zz, l_1x, l_1y, l_1z, m_1, Ia_1, fv_1, fc_1, fo_1, L_2xx, L_2yy, L_2zz, l_2x, l_2y, l_2z, m_2, Ia_2, fv_2, fc_2, fo_2, L_3xx, L_3yy, L_3zz, l_3x, l_3y, l_3z, m_3, Ia_3, fv_3, fc_3, fo_3];
syms q1 q2 q3 dq1 dq2 dq3 ddq1 ddq2 ddq3 g real;
q = [q1 q2 q3];
dq = [dq1 dq2 dq3];
ddq = [ddq1 ddq2 ddq3];

    x0 = sin(q(2));
    x1 = cos(q(2));
    x2 = dq(1)*x1;
    x3 = dq(2)*x2;
    x4 = ddq(1)*x0 + x3;
    x5 = dq(1)*x0;
    x6 = dq(2)*x5;
    x7 = -x6;
    x8 = ddq(1)*x1 + x7;
    x9 = 0.1*x0;
    x10 = x2*x5;
    x11 = ddq(2) + x10;
    x12 = 0.1*dq(1)^2;
    x13 = -dq(2)^2;
    x14 = x13 - x2^2;
    x15 = -ddq(2);
    x16 = -ddq(1);
    x17 = -0.1*x0*x16 - g*x1;
    x18 = -x4;
    x19 = -g*x0 + 0.1*x1*x16;
    x20 = x1*x19;
    x21 = sin(q(3));
    x22 = -x21;
    x23 = -dq(2);
    x24 = cos(q(3));
    x25 = x21*x23 + x24*x5;
    x26 = dq(3) + x2;
    x27 = x25*x26;
    x28 = x22*x5 + x23*x24;
    x29 = dq(3)*x28 + x15*x21 + x24*x4;
    x30 = x25*x28;
    x31 = -x30;
    x32 = -dq(3)*x25 + x15*x24 + x18*x21;
    x33 = x26*x28;
    x34 = -x33;
    x35 = ddq(3) + x8;
    x36 = -x27;
    x37 = -x32;
    x38 = x27 + x37;
    x39 = 0.25*x11 + x17;
    x40 = -x39;
    x41 = -x26^2;
    x42 = -x28^2;
    x43 = x41 + x42;
    x44 = x30 + x35;
    x45 = 0.25*x21;
    x46 = 0.25*x24;
    x47 = 0.25*x14 + x19;
    x48 = -x24;
    x49 = x12 + 0.25*x6 - 0.25*x8;
    x50 = x22*x47 + x48*x49;
    x51 = x30 - x35;
    x52 = x22*x49 + x24*x47;
    x53 = -x52;
    x54 = -x25^2;
    x55 = x41 + x54;
    x56 = x29 + x33;
    x57 = -x50;
    x58 = x42 + x54;
    x59 = x27 + x32;
    x60 = -x29 + x33;

Pb = [[Ia_1 + L_1zz + L_2yy - l_2z/5 + m_2/100 + 29*m_3/400], [fv_1], [fc_1], [fo_1], [L_2xx - L_2yy + L_3yy - m_3/16], [Ia_2 + L_2zz + L_3yy + m_3/16], [l_2x + m_3/4], [l_2y], [fv_2], [fc_2], [fo_2], [L_3xx - L_3yy], [L_3zz], [l_3x], [l_3y], [l_3z], [Ia_3], [fv_3], [fc_3], [fo_3]]';    
H = symmatrix('H',[60,1]);

x0 = sin(q(2));
x1 = dq(1)*x0;
x2 = dq(2)*x1;
x3 = cos(q(2));
x4 = dq(1)*x3;
x5 = dq(2)*x4;
x6 = ddq(1)*x0 + x5;
x7 = -x2;
x8 = -dq(2)^2;
x9 = -x4^2 + x8;
x10 = 0.1*dq(1)^2;
x11 = 0.1*x0;
x12 = x1*x4;
x13 = ddq(2) + x12;
x14 = -ddq(2);
x15 = cos(q(3));
x16 = sin(q(3));
x17 = -dq(2);
x18 = x1*x15 + x16*x17;
x19 = -x16;
x20 = x1*x19 + x15*x17;
x21 = x18*x20;
x22 = -x21;
x23 = dq(3)*x20 + x14*x16 + x15*x6;
x24 = dq(3) + x4;
x25 = x18*x24;
x26 = ddq(1)*x3 + x7;
x27 = ddq(3) + x26;
x28 = x20*x24;
x29 = -x25;
x30 = -x15;
x31 = x10 + 0.25*x2 - 0.25*x26;
x32 = -ddq(1);
x33 = -g*x0 + 0.1*x3*x32;
x34 = x33 + 0.25*x9;
x35 = x19*x34 + x30*x31;
x36 = 0.25*x16;
x37 = -x24^2;
x38 = -x20^2;
x39 = x37 + x38;
x40 = 0.25*x15;
x41 = x21 + x27;
x42 = -dq(3)*x18 + x14*x15 - x16*x6;
x43 = x25 - x42;
x44 = -0.1*x0*x32 - g*x3;
x45 = 0.25*x13 + x44;
x46 = -x45;
x47 = x23 + x28;
x48 = x15*x34 + x19*x31;
x49 = -x48;
x50 = x21 - x27;
x51 = -x18^2;
x52 = x37 + x51;
x53 = -x35;
x54 = x38 + x51;
x55 = -x23 + x28;
x56 = x25 + x42;

H(1) = ddq(1);
H(2) = 0;
H(3) = 0;
H(4) = dq(1);
H(5) = 0;
H(6) = 0;
H(7) = sign(dq(1));
H(8) = 0;
H(9) = 0;
H(10) = 1;
H(11) = 0;
H(12) = 0;
H(13) = x0*x6 + x2*x3;
H(14) = -x12;
H(15) = 0;
H(16) = x0*x5 + x3*x7;
H(17) = ddq(2);
H(18) = 0;
H(19) = -x10*x3 + x11*x13 - 0.1*x3*x9;
H(20) = x44;
H(21) = 0;
H(22) = x0*x10 + x11*(-x1^2 + x8) - 0.1*x3*(x12 + x14);
H(23) = -x33;
H(24) = 0;
H(25) = 0;
H(26) = dq(2);
H(27) = 0;
H(28) = 0;
H(29) = sign(dq(2));
H(30) = 0;
H(31) = 0;
H(32) = 1;
H(33) = 0;
H(34) = x0*(x15*x23 + x19*x25) + x22*x3;
H(35) = x19*x23 + x25*x30;
H(36) = x22;
H(37) = x0*(x15*x28 + x19*x29) + x27*x3;
H(38) = x19*x28 + x29*x30;
H(39) = x27;
H(40) = x0*x19*x46 + x11*x43 - 0.1*x3*(x15*x39 + x19*x41) + x3*(x35 + x36*x39 + x40*x41);
H(41) = x30*x46 + 0.25*x43;
H(42) = x35;
H(43) = x0*x15*x45 + x11*x47 - 0.1*x3*(x15*x50 + x19*x52) + x3*(x36*x50 + x40*x52 + x49);
H(44) = x19*x45 + 0.25*x47;
H(45) = x49;
H(46) = x0*(x15*x53 + x19*x48) + x11*x54 - 0.1*x3*(x15*x56 + x19*x55) + x3*(x36*x56 + x40*x55);
H(47) = x19*x53 + x30*x48 + 0.25*x54;
H(48) = 0;
H(49) = 0;
H(50) = 0;
H(51) = ddq(3);
H(52) = 0;
H(53) = 0;
H(54) = dq(3);
H(55) = 0;
H(56) = 0;
H(57) = sign(dq(3));
H(58) = 0;
H(59) = 0;
H(60) = 1;

Hb = symmatrix('H',[20,3]);
Hb(:,1) = H(1:20);
Hb(:,2) = H(21:40);
Hb(:,3) = H(41:60);
Hb(:,1)'*Pb